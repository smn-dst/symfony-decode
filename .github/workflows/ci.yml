name: "CI PHP"

on:
  push:
    paths:
      - src/**
      - .github/workflows/ci.yml
      - assets/**
      - tests/**
      - package.json
      - package-lock.json
      - phpstan.dist.neon

jobs:
  lint-js:
    name: "Lint JS (ESLint)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - run: npm ci
      - run: npm run lint

  php-quality:
    env:
      APP_ENV: test
    name: "Lint PHP (PHP-CS-Fixer + PHPStan)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - run: composer install --no-progress
      - run: composer run quality

  unit-tests:
    env:
      APP_ENV: test
    name: "Tests unitaires (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - run: composer install --no-progress
      - run: composer run phpunit:unit

  functional-tests:
    env:
      APP_ENV: test
    name: "Tests fonctionnels (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - run: composer install --no-progress
      - run: composer run phpunit:functional

  health-check:
    env:
      APP_ENV: test
    name: "Health-check (app répond en HTTP)"
    needs: ["lint-js", "php-quality", "unit-tests", "functional-tests"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - run: composer install --no-progress
      
      - name: Démarrer le serveur PHP
        run: |
          php -S 127.0.0.1:8000 -t public > /dev/null 2>&1 &
          sleep 5
      
      - name: Vérifier que l'app répond
        run: |
          curl -f http://127.0.0.1:8000/health

  e2e:
    env:
      APP_ENV: test
    name: "Tests e2e (Cypress)"
    needs: ["health-check"]  # E2E AVANT BUILD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - run: composer install --no-progress
      - run: npm ci
      - name: Démarrer le serveur et lancer Cypress
        run: |
          php -S 127.0.0.1:8000 -t public > /dev/null 2>&1 &
          sleep 5
          npx cypress run

  build:
    env:
      APP_ENV: prod
    name: "Build Production"
    needs: ["e2e"]  # BUILD APRÈS LES TESTS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      
      - name: Créer .env de production minimal
        run: |
          echo "APP_ENV=prod" > .env
          echo "APP_SECRET=build-secret-for-ci" >> .env
      
      # Installer SANS --no-dev d'abord pour générer le cache
      - run: composer install --no-progress
      
      # Nettoyer le cache et warmup en prod
      - name: Cache warmup
        run: |
          php bin/console cache:clear --env=prod --no-debug
          php bin/console cache:warmup --env=prod --no-debug
      
      # Maintenant réinstaller en mode production
      - run: composer install --no-progress --no-dev --optimize-autoloader
      
      - run: echo "Build terminé"

  notify:
    name: "Résultat CI"
    needs: ["lint-js", "php-quality", "unit-tests", "functional-tests", "health-check", "e2e", "build"]
    runs-on: ubuntu-latest
    steps:
      - name: Afficher le résultat
        run: |
          echo "Toutes les étapes ont été exécutées avec succès"