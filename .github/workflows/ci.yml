name: "CI PHP"

on:
  push:
    paths:
      - src/**
      - .github/workflows/ci.yml
      - assets/**
      - tests/**
      - package.json
      - package-lock.json
      - phpstan.dist.neon
      - cypress.config.js
      - tests/e2e/smoke.cy.js

jobs:

  deps:
    name: "Installer les dépendances"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
      - uses: actions/cache@v4
        id: cache
        with:
          php-version: "8.4"
          extensions: amqp
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
      - run: composer install --no-progress
        if: steps.cache.outputs.cache-hit != 'true'

  lint-js:
    name: "Lint JS (ESLint)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - run: npm ci
      - run: npm run lint

  php-quality:
    env:
      APP_ENV: test
    name: "Lint PHP (PHP-CS-Fixer + PHPStan)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      - run: composer run quality

  unit-tests:
    env:
      APP_ENV: test
    name: "Tests unitaires (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env      
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      - run: composer run phpunit:unit

  functional-tests:
    env:
      APP_ENV: test
    name: "Tests fonctionnels (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      - run: composer run phpunit:functional

  health-check:
    env:
      APP_ENV: test
    name: "Health-check (app répond en HTTP)"
    needs: ["lint-js", "php-quality", "unit-tests", "functional-tests"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      
      - name: Démarrer le serveur PHP
        run: |
          php -S 127.0.0.1:8000 -t public > /dev/null 2>&1 &
          sleep 5
      
      - name: Vérifier que l'app répond
        run: |
          curl -f http://127.0.0.1:8000/health

  e2e:
    env:
      APP_ENV: test
    name: "Tests e2e (Cypress)"
    needs: ["health-check"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      - run: npm ci
      
      - name: Démarrer le serveur et lancer Cypress
        run: |
          php -S 127.0.0.1:8000 -t public > /dev/null 2>&1 &
          sleep 5
          npx cypress run

  build:
    env:
      APP_ENV: test
    name: "Build"
    needs: ["e2e"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: amqp
      
      - name: Préparer .env pour la CI
        run: cp .env.test .env
      
      - uses: actions/cache@v4
        with:
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-dev
          path: vendor
      
      - name: Cache warmup
        run: |
          php bin/console cache:clear --env=test --no-debug
          php bin/console cache:warmup --env=test --no-debug
      
      - run: composer install --no-progress --optimize-autoloader
      
      - run: echo "Build OK"

  notify:
    name: "Résultat CI"
    needs: ["lint-js", "php-quality", "unit-tests", "functional-tests", "health-check", "e2e", "build"]
    runs-on: ubuntu-latest
    steps:
      - name: Afficher le résultat
        run: |
          echo "CI terminée"