# On commence toujours par le nom de la workflow
name: "CI PHP"

# On définit les événements qui déclenchent la workflow
on:
  push:
    paths:
      - src/**
      - .github/workflows/ci.yml
      - assets/**
      - tests/**
      - package.json
      - package-lock.json

# On définit les jobs qui seront exécutés
jobs:
  hello:
    if: false # This job will not run
    runs-on: ubuntu-latest
    steps:
      - name: "Say Hello World"
        run: echo "Hello world!"

      - name: "List current folder"
        run: ls -la

      - name: "Create file"
        run: touch test-file

      - name: "List current folder after creating file"
        run: ls -la

  lint-js:
    name: "Lint JS (ESLint)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - run: npm ci
      - run: npm run lint

  php-quality:
    name: "Lint PHP (PHP-CS-Fixer + PHPStan)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress
      - run: composer run quality

  unit-tests:
    name: "Tests unitaires (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress
      - run: composer run phpunit:unit

  functional-tests:
    name: "Tests fonctionnels (PHPUnit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress
      - run: composer run phpunit:functional

  health-check:
    name: "Health-check (app répond en HTTP)"
    needs: ["lint-js", "php-quality"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress
      - name: Démarrer le serveur PHP
        run: |
          composer serve &
          sleep 3s
      - name: Vérifier que l'app répond
        run: |
          curl http://127.0.0.1:8000/home

  build:
    name: "Build"
    needs: ["unit-tests", "functional-tests", "health-check"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress --no-dev
      - run: echo "Build terminé"

  e2e:
    name: "Tests e2e (Cypress)"
    needs: ["build"]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
      - run: composer install --no-progress
      - run: npm ci
      - name: Démarrer le serveur et lancer Cypress
        run: |
          php -S 127.0.0.1:8000 -t public &
          sleep 3s
          npx cypress run

  notify:
    name: "Résultat CI"
    needs: ["lint-js", "php-quality", "unit-tests", "functional-tests", "health-check", "build", "e2e"]
    runs-on: ubuntu-latest
    steps:
      - name: Afficher le résultat
        run: |
          echo "Toutes les étapes ont été exécutées avec succès"